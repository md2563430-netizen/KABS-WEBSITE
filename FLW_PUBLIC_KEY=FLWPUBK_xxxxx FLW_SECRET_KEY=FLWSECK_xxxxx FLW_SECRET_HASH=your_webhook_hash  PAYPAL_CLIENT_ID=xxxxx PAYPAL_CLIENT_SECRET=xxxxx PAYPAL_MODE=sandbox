"use client"


import { useEffect, useMemo, useState } from "react"
import Link from "next/link"
import { motion } from "framer-motion"
import Card from "@/components/Card"
import Button from "@/components/Button"
import { BulkDraft, BulkUseCaseId, draftStorageKey, estimateCost, useCases } from "@/lib/bulkSms"

function readDraft(useCase: BulkUseCaseId) {
  try {
    const raw = localStorage.getItem(draftStorageKey(useCase))
    if (!raw) return null
    return JSON.parse(raw) as BulkDraft
  } catch {
    return null
  }
}

export default function PaymentPage({ params }: { params: { useCase: string } }) {
  const useCase = params.useCase as BulkUseCaseId
  const uc = useCases.find((u) => u.id === useCase)

  const [draft, setDraft] = useState<BulkDraft | null>(null)
  const [loading, setLoading] = useState<"paypal" | "flutterwave" | null>(null)
  const [error, setError] = useState<string>("")

  useEffect(() => {
    setDraft(readDraft(useCase))
  }, [useCase])

  const cost = useMemo(() => (draft ? estimateCost(draft) : null), [draft])

  async function payWithFlutterwave() {
    if (!cost) return
    setLoading("flutterwave")
    setError("")
    try {
      const res = await fetch("/api/bulk-sms/pay/flutterwave/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount: cost.total,
          currency: "UGX",
          email: draft?.contactEmail || "customer@kabspromotions.com",
          name: draft?.contactName || "Bulk SMS Customer",
          useCase,
        }),
      })

      const data = await res.json()
      if (!data.redirectUrl) throw new Error("Failed to start Flutterwave payment")

      window.location.href = data.redirectUrl
    } catch (e: any) {
      setError(e.message || "Payment failed")
      setLoading(null)
    }
  }

  async function payWithPaypal() {
    if (!cost) return
    setLoading("paypal")
    setError("")
    try {
      const res = await fetch("/api/bulk-sms/pay/paypal/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount: cost.total,
          currency: "USD",
          useCase,
        }),
      })

      const data = await res.json()
      if (!data.redirectUrl) throw new Error("Failed to start PayPal payment")

      window.location.href = data.redirectUrl
    } catch (e: any) {
      setError(e.message || "Payment failed")
      setLoading(null)
    }
  }

  if (!uc || !draft || !cost) {
    return (
      <div className="min-h-screen p-10">
        <p className="text-text-primary">Payment data missing.</p>
        <Link href="/bulk-sms" className="text-accent-gold underline">
          Back to Bulk SMS
        </Link>
      </div>
    )
  }

  return (
    <>
      <style
        dangerouslySetInnerHTML={{
          __html: `
          .glass-effect {
            background: rgba(11, 18, 32, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.1);
          }
          .glossy-overlay {
            background: linear-gradient(
              135deg,
              rgba(255,255,255,0.1) 0%,
              rgba(255,255,255,0.05) 50%,
              transparent 100%
            );
          }
          .glow-effect {
            box-shadow: 0 0 30px rgba(245,179,1,0.25),
                        0 0 60px rgba(245,179,1,0.15);
          }
        `,
        }}
      />

      <div className="min-h-screen py-12 px-4 sm:px-6 lg:px-8 relative">
        {/* Background */}
        <div className="fixed inset-0 -z-10 bg-gradient-to-br from-background via-card/50 to-background">
          <div className="absolute inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(245,179,1,0.1),transparent_50%)]" />
          <div className="absolute inset-0 bg-[radial-gradient(circle_at_70%_80%,rgba(255,138,0,0.1),transparent_50%)]" />
        </div>

        <div className="max-w-5xl mx-auto">
          {/* Header */}
          <motion.div initial={{ opacity: 0, y: 18 }} animate={{ opacity: 1, y: 0 }} className="mb-10">
            <Link
              href={`/bulk-sms/${useCase}/confirm`}
              className="flex items-center gap-2 text-text-muted hover:text-accent-gold transition mb-6"
            >
              ← Back to Confirm
            </Link>

            <h1 className="text-4xl sm:text-5xl font-bold">
              <span className="bg-gradient-to-r from-accent-gold via-accent-orange to-accent-gold bg-clip-text text-transparent">
                Payment
              </span>
            </h1>
            <p className="text-text-muted mt-2">
              Step 3 of 3 — Choose a payment method to complete your campaign.
            </p>
          </motion.div>

          <div className="glass-effect rounded-3xl overflow-hidden glow-effect">
            <div className="relative p-6 sm:p-8">
              <div className="absolute inset-0 glossy-overlay pointer-events-none" />
              <div className="relative z-10 grid grid-cols-1 lg:grid-cols-12 gap-8">
                {/* Payment methods */}
                <div className="lg:col-span-7 space-y-6">
                  <Card>
                    <h2 className="text-2xl font-bold mb-2">Mobile Money / Cards</h2>
                    <p className="text-text-muted mb-4">
                      Pay securely using MTN, Airtel Uganda, or debit/credit cards.
                    </p>
                    <Button
                      variant="primary"
                      className="w-full"
                      disabled={loading !== null}
                      onClick={payWithFlutterwave}
                    >
                      {loading === "flutterwave" ? "Redirecting…" : "Pay with Mobile Money / Card"}
                    </Button>
                  </Card>

                  <Card>
                    <h2 className="text-2xl font-bold mb-2">PayPal</h2>
                    <p className="text-text-muted mb-4">
                      Pay securely using your PayPal balance or linked cards.
                    </p>
                    <Button
                      variant="outline"
                      className="w-full"
                      disabled={loading !== null}
                      onClick={payWithPaypal}
                    >
                      {loading === "paypal" ? "Redirecting…" : "Pay with PayPal"}
                    </Button>
                  </Card>

                  {error && (
                    <div className="rounded-xl border border-red-500/30 bg-red-500/10 p-4 text-red-300">
                      {error}
                    </div>
                  )}
                </div>

                {/* Summary */}
                <div className="lg:col-span-5">
                  <Card>
                    <h2 className="text-2xl font-bold mb-4">Order Summary</h2>
                    <div className="space-y-2 text-sm text-text-muted">
                      <p>
                        <span className="text-text-primary font-semibold">Campaign:</span>{" "}
                        {draft.campaignName}
                      </p>
                      <p>
                        <span className="text-text-primary font-semibold">Recipients:</span>{" "}
                        {cost.qty}
                      </p>
                      <p>
                        <span className="text-text-primary font-semibold">Segments:</span>{" "}
                        {cost.segments}
                      </p>
                      <p className="pt-3 text-lg">
                        <span className="text-text-primary font-semibold">Total:</span>{" "}
                        <span className="text-accent-gold font-bold">
                          {cost.currency} {cost.total.toFixed(2)}
                        </span>
                      </p>
                    </div>
                  </Card>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  )
}
